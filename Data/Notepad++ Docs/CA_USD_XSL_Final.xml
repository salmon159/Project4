<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
	<xsl:output encoding="UTF-8" indent="yes" method="xml"/>
	<!-- Root -->
	<xsl:template match="/">
		<xsl:apply-templates select="/OrderList/OrderHeader"/>
	</xsl:template>
	<!-- OrderHeader -->
	<!--
	<xsl:template match="OrderHeader">
		 Calculate PaidAmount & TotalOrderValue  
		<xsl:variable name="varTotalOrderTaxUS" select="sum(/OrderList/Order/OrderLines/OrderLine/Extn/@ExtnTotalTaxUS)"/>
		<xsl:variable name="varOrderOrderUnitPrice" select="sum(/OrderList/Order/OrderLines/OrderLine/Extn/@ExtnOrderUnitPriceUS)"/>
		<xsl:variable name="totalOrderValueUS" select="$varTotalOrderTaxUS + $varOrderOrderUnitPrice"/>
		<xsl:variable name="totalDiscountUS" select="sum(/OrderList/Order/OrderLines/OrderLine/Extn/@ExtnERPDiscountValueUS)"/>
		<xsl:variable name="calculatedValue" select="$totalOrderValueUS - $totalDiscountUS"/>
		<xsl:variable name="varhShippingCharge" select="sum(/OrderList/Order/OrderLines/OrderLine/Extn/@ExtnTotalShippingChargeUS)"/>
		<xsl:variable name="varhShippingTax" select="sum(/OrderList/Order/OrderLines/OrderLine/Extn/@ExtnTotalShippingTaxUS)"/>
		<OrderHeader>
			 Always output attributes 
			<xsl:attribute name="TotalOrderValue">
				<xsl:value-of select="$calculatedValue"/>
			</xsl:attribute>
			<xsl:attribute name="PaidAmount">
				<xsl:value-of select="$calculatedValue"/>
			</xsl:attribute>
			<xsl:attribute name="ShippingCharge">
				<xsl:value-of select="$varhShippingCharge"/>
			</xsl:attribute>
			<xsl:attribute name="ShippingTax">
				<xsl:value-of select="$varhShippingTax"/>
			</xsl:attribute>
			<xsl:attribute name="Currency">USD</xsl:attribute>
			<xsl:apply-templates select="@*[not(name() = 'TotalOrderValue' or name() = 'PaidAmount' or name() = 'ShippingCharge' or name() = 'ShippingTax'  or name() = 'Currency')]"/>
			 Copy children 
			<xsl:apply-templates select="OrderDetails"/>
			<xsl:apply-templates select="node()[not(self::OrderDetails)]"/>
		</OrderHeader>
	</xsl:template>
	
	-->
	
	<!-- PaymentInfo: update Amount -->
	<xsl:template match="PaymentInfo">
		<PaymentInfo>
			<xsl:for-each select="@*">
				<xsl:choose>
					<xsl:when test="name()='Amount'">
						<xsl:attribute name="Amount">
							<xsl:value-of select="/OrderList/Order/Extn/@ExtnAmountUS"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<xsl:apply-templates select="node()"/>
		</PaymentInfo>
	</xsl:template>
	<!-- PaymentInfo: update Amount -->
	<xsl:template match="PaymentMethod">
		<PaymentMethod>
			<xsl:for-each select="@*">
				<xsl:choose>
					<xsl:when test="name()='CCAmount'">
						<xsl:attribute name="CCAmount">
							<xsl:value-of select="/OrderList/Order/Extn/@ExtnAmountUS"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<xsl:apply-templates select="node()"/>
		</PaymentMethod>
	</xsl:template>
	<!-- OrderDetail loop -->
	<xsl:template match="OrderDetail">
		<xsl:variable name="itemCode" select="@ItemCode"/>
		<xsl:variable name="lotNo" select="@LotNumber"/>
		<xsl:variable name="matchLine" select="/OrderList/Order/OrderLines/OrderLine[Extn/@ExtnItemCode=$itemCode and Extn/@ExtnLotNo=$lotNo]"/>
		<OrderDetail>
			<xsl:apply-templates select="@*"/>
			<xsl:apply-templates select="node()">
				<xsl:with-param name="matchLine" select="$matchLine"/>
			</xsl:apply-templates>
		</OrderDetail>
	</xsl:template>
	<!-- OrderDetail fields update -->
	<xsl:template match="OrderDetail">
		<xsl:variable name="itemCode" select="@ItemCode"/>
		<xsl:variable name="lotNo" select="@LotNumber"/>
		<xsl:variable name="matchLine" select="/OrderList/Order/OrderLines/OrderLine[Extn/@ExtnItemCode=$itemCode and Extn/@ExtnLotNo=$lotNo]"/>
		<OrderDetail>
			<!-- Copy existing attributes first -->
			<xsl:apply-templates select="@*"/>
			<!-- Now add/override new attributes -->
			<xsl:attribute name="OrderUnitPrice">
				<xsl:value-of select="$matchLine/Extn/@ExtnOrderUnitPriceUS"/>
			</xsl:attribute>
			<xsl:attribute name="GoldRate">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldRateUS"/>
			</xsl:attribute>
			<xsl:attribute name="GoldValue">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldValueUS"/>
			</xsl:attribute>
			<xsl:attribute name="StoneValue">
				<xsl:value-of select="$matchLine/Extn/@ExtnStoneValueUS"/>
			</xsl:attribute>
			<xsl:attribute name="MakingChargesValue">
				<xsl:value-of select="$matchLine/Extn/@ExtnMakingChargesValueUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnTariffAmount">
				<xsl:value-of select="$matchLine/Extn/@ExtnTariffAmountUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnMakingChargesPerGram">
				<xsl:value-of select="$matchLine/Extn/@ExtnMakingChargesPerGramUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnMakingChargesPerUnit">
				<xsl:value-of select="$matchLine/Extn/@ExtnMakingChargesPerUnitUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnGoldRate24KT">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldRate24KTUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnGoldRate22KT">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldRate22KTUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnGoldRate21KT">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldRate21KTUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnGoldRate18KT">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldRate18KTUS"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnGoldRate14KT">
				<xsl:value-of select="$matchLine/Extn/@ExtnGoldRate14KTUS"/>
			</xsl:attribute>
			<xsl:attribute name="DiscountValue">
				<xsl:value-of select="$matchLine/Extn/@ExtnDiscountValueUS"/>
			</xsl:attribute>
			<xsl:attribute name="BillLevelDiscount">
				<xsl:value-of select="$matchLine/Extn/@ExtnBillLevelDiscountUS"/>
			</xsl:attribute>
			<xsl:attribute name="ERPDiscountValue">
				<xsl:value-of select="$matchLine/Extn/@ExtnERPDiscountValueUS"/>
			</xsl:attribute>
			<xsl:attribute name="TotalTax">
				<xsl:value-of select="$matchLine/Extn/@ExtnTotalTaxUS"/>
			</xsl:attribute>
			<xsl:variable name="varTotalTaxUS" select="$matchLine/Extn/@ExtnTotalTaxUS"/>
			<xsl:variable name="varOrderUnitPrice" select="$matchLine/Extn/@ExtnOrderUnitPriceUS"/>
			<xsl:variable name="varShipTaxUS" select="$matchLine/Extn/@ExtnTotalShippingTaxUS"/>
			<xsl:variable name="varShipCharge" select="$matchLine/Extn/@ExtnTotalShippingChargeUS"/>
			<xsl:variable name="varCustomDuty" select="$matchLine/Extn/@ExtnCustomDutyTaxUS"/>
			
			<xsl:attribute name="ExtnTotalShippingTaxUS">
				<xsl:value-of select="format-number((number($varShipTaxUS)),'0.00')"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnTotalShippingChargeUS">
				<xsl:value-of select="format-number((number($varShipCharge)),'0.00')"/>
			</xsl:attribute>
			<xsl:attribute name="OrderLineValue">
				<xsl:value-of select="format-number((number($varTotalTaxUS)+number($varOrderUnitPrice)+number($varCustomDuty)),'0.00')"/>
			</xsl:attribute>
			<xsl:attribute name="ExtnCustomDutyTaxUS">
				<xsl:value-of select="$matchLine/Extn/@ExtnCustomDutyTaxUS"/>
			</xsl:attribute>
			<!-- Copy all child nodes (preserve LineCharges, LineTaxes, etc.) -->
			<xsl:apply-templates select="node()"/>
		</OrderDetail>
	</xsl:template>
	<!-- TitanPaymentDetailList -->
	<xsl:template match="TitanPaymentDetailList">
		<TitanPaymentDetailList>
			<xsl:apply-templates select="TitanPaymentDetail">
				<xsl:with-param name="matchLine" select="../.."/>
				<!-- pass parent OrderDetail's matchLine down -->
			</xsl:apply-templates>
		</TitanPaymentDetailList>
	</xsl:template>
	<!-- TitanPaymentDetail update -->
	<xsl:template match="TitanPaymentDetail">
		<xsl:variable name="itemCode" select="../../@ItemCode"/>
		<xsl:variable name="lotNo" select="../../@LotNumber"/>
		<xsl:variable name="matchLine" select="/OrderList/Order/OrderLines/OrderLine[Extn/@ExtnItemCode=$itemCode and Extn/@ExtnLotNo=$lotNo]"/>
		<TitanPaymentDetail>
			<!-- Copy existing attributes first -->
			<xsl:apply-templates select="@*"/>
			<xsl:attribute name="Amount">
				<xsl:value-of select="$matchLine/Extn/@ExtnAmountUS"/>
			</xsl:attribute>
			<xsl:apply-templates select="node()"/>
		</TitanPaymentDetail>
	</xsl:template>
	<!-- LineTaxes -->
	<xsl:template match="LineTaxes">
		<LineTaxes>
			<xsl:apply-templates select="LineTax"/>
		</LineTaxes>
	</xsl:template>
	<!-- LineTaxes -->
	<xsl:template match="LineTaxes">
		<LineTaxes>
			<xsl:apply-templates select="LineTax"/>
		</LineTaxes>
	</xsl:template>
	<!-- LineTax -->
	<xsl:template match="LineTax">
		<xsl:variable name="itemCode" select="../../@ItemCode"/>
		<xsl:variable name="lotNo" select="../../@LotNumber"/>
		<xsl:variable name="matchLine" select="/OrderList/Order/OrderLines/OrderLine[                     Extn/@ExtnItemCode=$itemCode and Extn/@ExtnLotNo=$lotNo]"/>
		<LineTax>
			<!-- copy all attributes, overriding when required -->
			<xsl:for-each select="@*">
				<xsl:choose>
					<!-- ShippingTaxBreakup State Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='ShippingTaxBreakup'                                  and ../@TaxName='State Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnShippingStateTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- ShippingTaxBreakup Country Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='ShippingTaxBreakup'                                  and ../@TaxName='Country Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnShippingCountryTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- ShippingTaxBreakup Special Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='ShippingTaxBreakup'                                  and ../@TaxName='Special Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnShippingSpecialTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- ShippingTaxBreakup County Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='ShippingTaxBreakup'                                  and ../@TaxName='County Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnShippingCountyTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- ShippingTaxBreakup City Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='ShippingTaxBreakup'                                  and ../@TaxName='City Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnShippingCityTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- ShippingTax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='Shipping'                                  and ../@TaxName='Shipping Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnTotalShippingTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- CustomDuty override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='CustomDuty'                                  and ../@TaxName='CustomDuty'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnCustomDutyTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- Sales Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='Price'                                  and ../@TaxName='Sales Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnSalesTax"/>
						</xsl:attribute>
					</xsl:when>
					<!-- State Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='SalesTaxBreakup'                                  and ../@TaxName='State Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnStateTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- SalesTaxBreakup Country Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='SalesTaxBreakup'                                  and ../@TaxName='Country Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnCountryTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- SalesTaxBreakup Special Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='SalesTaxBreakup'                                  and ../@TaxName='Special Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnSpecialTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- SalesTaxBreakup County Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='SalesTaxBreakup'                                  and ../@TaxName='County Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnCountyTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- SalesTaxBreakup City Tax override -->
					<xsl:when test="name()='Tax'                                  and ../@ChargeCategory='SalesTaxBreakup'                                  and ../@TaxName='City Tax'">
						<xsl:attribute name="Tax">
							<xsl:value-of select="$matchLine/Extn/@ExtnCityTaxUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- otherwise just copy -->
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<!-- copy children if any -->
			<xsl:apply-templates select="node()"/>
		</LineTax>
	</xsl:template>
	<!-- LineCharges -->
	<xsl:template match="LineCharges">
		<LineCharges>
			<xsl:apply-templates select="LineCharge"/>
		</LineCharges>
	</xsl:template>
	<!-- LineCharge -->
	<xsl:template match="LineCharge ">
		<xsl:variable name="itemCode" select="../../@ItemCode"/>
		<xsl:variable name="lotNo" select="../../@LotNumber"/>
		<xsl:variable name="matchLine" select="/OrderList/Order/OrderLines/OrderLine[                     Extn/@ExtnItemCode=$itemCode and Extn/@ExtnLotNo=$lotNo]"/>
		<LineCharge>
			<!-- copy all attributes, overriding when required -->
			<xsl:for-each select="@*">
				<xsl:choose>
					<!-- ShippingTaxBreakup State Tax override -->
					<xsl:when test="name()='ChargeAmount'                                  and ../@ChargeCategory='Shipping'                                  and ../@ChargeName='Shipping'">
						<xsl:attribute name="ChargeAmount">
							<xsl:value-of select="$matchLine/Extn/@ExtnTotalShippingChargeUS"/>
						</xsl:attribute>
					</xsl:when>
					<!-- otherwise just copy -->
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<!-- copy children if any -->
			<xsl:apply-templates select="node()"/>
		</LineCharge>
	</xsl:template>
	<!-- Default copy -->
	<xsl:template match="@*|node()">
		<xsl:copy>
			<xsl:apply-templates select="@*|node()"/>
		</xsl:copy>
	</xsl:template>
</xsl:stylesheet>



###################################################################################################################################
###################################################################################################################################
###################################################################################################################################


<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
	<!-- Identity template: copy everything by default -->
	<xsl:template match="@*|node()">
		<xsl:copy>
			<xsl:apply-templates select="@*|node()"/>
		</xsl:copy>
	</xsl:template>
	<!-- Override OrderHeader to update TotalOrderValue -->
	<xsl:template match="OrderHeader">
		<xsl:variable name="vOrdertotal">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@OrderLineValue)"/>
		</xsl:variable>
		<xsl:variable name="vCustomDutyTax">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@ExtnCustomDutyTaxUS)"/>
		</xsl:variable>
		<xsl:variable name="vOrderShipCharge">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@ExtnTotalShippingChargeUS)"/>
		</xsl:variable>
		<xsl:variable name="vOrderShipTax">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@ExtnTotalShippingTaxUS)"/>
		</xsl:variable>
		<xsl:variable name="vOrderPaidAmount">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/TitanPaymentDetailList/TitanPaymentDetail[@PaymentCode='CC']/@Amount)"/>
		</xsl:variable>
		<xsl:variable name="TotalOrderValue">
			<xsl:value-of select="sum(OrderDetails/@TotalOrderValue)"/>
		</xsl:variable>
		<xsl:variable name="TotalOrderValue">
			<xsl:value-of select="sum(OrderDetails/@TotalOrderValue)"/>
		</xsl:variable>
		<xsl:copy>
			<!-- Copy all attributes except TotalOrderValue -->
			<xsl:for-each select="@*">
				<xsl:choose>
				<!--
					<xsl:when test="name() = 'TotalOrderValue'">
						<xsl:attribute name="TotalOrderValue">
							<xsl:value-of select="format-number((number($vOrdertotal)+number($vOrderShipCharge)+number($vOrderShipTax)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
				-->
					<xsl:when test="name() = 'TotalOrderValue'">
						<xsl:attribute name="TotalOrderValue">
							<xsl:value-of select="format-number((number($vOrdertotal)+number($vOrderShipCharge)+number($vOrderShipTax)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:when test="name() = 'PaidAmount'">
						<xsl:attribute name="PaidAmount">
							<xsl:value-of select="format-number((number($vOrderPaidAmount)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:when test="name() = 'ShippingCharge'">
						<xsl:attribute name="ShippingCharge">
							<xsl:value-of select="format-number((number($vOrderShipCharge)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:when test="name() = 'ShippingTax'">
						<xsl:attribute name="ShippingTax">
							<xsl:value-of select="format-number((number($vOrderShipTax)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<!-- Copy children -->
			<xsl:apply-templates select="node()"/>
		</xsl:copy>
	</xsl:template>
	<!-- PaymentInfo: update Amount -->
	<xsl:template match="PaymentMethod">
		<xsl:variable name="vOrderCCAmount">
			<xsl:value-of select="sum(/OrderHeader/OrderDetails/OrderDetail/TitanPaymentDetailList/TitanPaymentDetail[@PaymentCode='CC']/@Amount)"/>
		</xsl:variable>
		<PaymentMethod>
			<xsl:for-each select="@*">
				<xsl:choose>
					<xsl:when test="name()='CCAmount'">
						<xsl:attribute name="CCAmount">
							<xsl:value-of select="format-number((number($vOrderCCAmount)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<xsl:apply-templates select="node()"/>
		</PaymentMethod>
	</xsl:template>
</xsl:stylesheet>










<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
	<!-- Identity template: copy everything by default -->
	<xsl:template match="@*|node()">
		<xsl:copy>
			<xsl:apply-templates select="@*|node()"/>
		</xsl:copy>
	</xsl:template>
	<!-- Override OrderHeader to update TotalOrderValue -->
	<xsl:template match="OrderHeader">
		<xsl:variable name="vOrdertotal">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@OrderLineValue)"/>
		</xsl:variable>
		<xsl:variable name="vCustomDutyTax">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@ExtnCustomDutyTaxUS)"/>
		</xsl:variable>
		<xsl:variable name="vOrderShipCharge">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@ExtnTotalShippingChargeUS)"/>
		</xsl:variable>
		<xsl:variable name="vOrderShipTax">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/@ExtnTotalShippingTaxUS)"/>
		</xsl:variable>
		<xsl:variable name="vOrderPaidAmount">
			<xsl:value-of select="sum(OrderDetails/OrderDetail/TitanPaymentDetailList/TitanPaymentDetail[@PaymentCode='CC']/@Amount)"/>
		</xsl:variable>
		<xsl:variable name="vTotalOrderValue">
			<xsl:value-of select="@TotalOrderValue"/>
		</xsl:variable>
		<xsl:variable name="vConversionRate">
			<xsl:value-of select="OrderDetails/OrderDetail/@ExtnConversionRate"/>
		</xsl:variable>
		<xsl:variable name="vTotalUSD">
			<xsl:value-of select="(number($vTotalOrderValue) div number($vConversionRate))"/>
		</xsl:variable>
		<xsl:copy>
			<!-- Copy all attributes except TotalOrderValue -->
			<xsl:for-each select="@*">
			<xsl:attribute name="Currency">USD</xsl:attribute>
				<xsl:choose>
					<!--
					<xsl:when test="name() = 'TotalOrderValue'">
						<xsl:attribute name="TotalOrderValue">
							<xsl:value-of select="format-number((number($vOrdertotal)+number($vOrderShipCharge)+number($vOrderShipTax)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
				-->
					<xsl:when test="name() = 'TotalOrderValue'">
						<xsl:attribute name="TotalOrderValue">
							<xsl:value-of select="format-number(($vTotalUSD),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:when test="name() = 'PaidAmount'">
						<xsl:attribute name="PaidAmount">
							<xsl:value-of select="format-number((number($vOrderPaidAmount)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					
					<xsl:when test="name() = 'ShippingCharge'">
						<xsl:attribute name="ShippingCharge">
							<xsl:value-of select="format-number((number($vOrderShipCharge)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:when test="name() = 'ShippingTax'">
						<xsl:attribute name="ShippingTax">
							<xsl:value-of select="format-number((number($vOrderShipTax)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<!-- Copy children -->
			<xsl:apply-templates select="node()"/>
		</xsl:copy>
	</xsl:template>
	<!-- PaymentInfo: update Amount -->
	<xsl:template match="PaymentMethod">
		<xsl:variable name="vOrderCCAmount">
			<xsl:value-of select="sum(/OrderHeader/OrderDetails/OrderDetail/TitanPaymentDetailList/TitanPaymentDetail[@PaymentCode='CC']/@Amount)"/>
		</xsl:variable>
		<PaymentMethod>
			<xsl:for-each select="@*">
				<xsl:choose>
					<xsl:when test="name()='CCAmount'">
						<xsl:attribute name="CCAmount">
							<xsl:value-of select="format-number((number($vOrderCCAmount)),'0.00')"/>
						</xsl:attribute>
					</xsl:when>
					<xsl:otherwise>
						<xsl:copy/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
			<xsl:apply-templates select="node()"/>
		</PaymentMethod>
	</xsl:template>
</xsl:stylesheet>
